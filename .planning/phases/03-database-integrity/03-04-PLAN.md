---
phase: 03-database-integrity
plan: 04
type: execute
depends_on: ["03-01", "03-02", "03-03"]
files_modified: []
---

<objective>
Audit remaining tables and complete Phase 3 verification: evidence, messages, push_tokens, push_subscriptions, secure_form_links, job_positions, panel_physicians, audit_logs.

Purpose: Complete database integrity audit and verify overall schema health.
Output: Phase 3 complete with all 27 tables audited.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-database-integrity/03-01-SUMMARY.md
@.planning/phases/03-database-integrity/03-02-SUMMARY.md
@.planning/phases/03-database-integrity/03-03-SUMMARY.md

**Remaining tables:**
- evidence (incident_id FK, file uploads)
- messages (incident_id FK, communication)
- push_tokens (device registry, unique token)
- push_subscriptions (incident_id FK, token FK)
- secure_form_links (incident_id FK, token_hash)
- job_positions (reference table, unique title)
- panel_physicians (reference table)
- audit_logs (entity logging)

**Key API files:**
@apps/web/src/app/api/evidence/route.js
@apps/web/src/app/api/messages/route.js
@apps/web/src/app/api/push-tokens/route.js
@apps/web/src/app/api/push-subscriptions/route.js
@apps/web/src/app/api/secure-form-links/route.js
@apps/web/src/app/api/job-positions/route.js
@apps/web/src/app/api/panel-physicians/route.js
@apps/web/src/app/api/audit-logs/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit evidence, messages, and notification tables</name>
  <files>apps/web/src/app/api/evidence/route.js, apps/web/src/app/api/messages/route.js, apps/web/src/app/api/push-tokens/route.js, apps/web/src/app/api/push-subscriptions/route.js</files>
  <action>
Read and verify:

1. **evidence table:**
   - Primary key: id
   - Foreign key: incident_id → incidents(id)
   - file_url, file_type, file_name, file_size
   - uploaded_by (no FK constraint expected)
   - upload_status field

2. **messages table:**
   - Primary key: id
   - Foreign key: incident_id → incidents(id)
   - sender_name (no FK - just string)
   - body (NOT NULL)

3. **push_tokens table:**
   - Primary key: id
   - Unique: expo_push_token
   - device_id, platform
   - Upsert pattern: ON CONFLICT DO UPDATE

4. **push_subscriptions table:**
   - Primary key: id
   - Composite unique: (incident_id, expo_push_token)
   - Foreign key: incident_id → incidents(id)
   - Token reference (not FK, just string match)

Document patterns and any gaps.
  </action>
  <verify>
Read evidence, messages, push routes. Confirm:
- incident_id FKs present where expected
- Unique constraints on tokens
  </verify>
  <done>
Evidence, messages, and notification tables audited.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit secure_form_links, job_positions, panel_physicians, audit_logs</name>
  <files>apps/web/src/app/api/secure-form-links/route.js, apps/web/src/app/api/job-positions/route.js, apps/web/src/app/api/panel-physicians/route.js, apps/web/src/app/api/audit-logs/route.js</files>
  <action>
Read and verify:

1. **secure_form_links table:**
   - Primary key: id
   - Foreign key: incident_id → incidents(id)
   - token_hash (SHA-256), access_code_hash (Argon2)
   - expires_at, revoked_at timestamps
   - form_type, form_record_id references

2. **job_positions table:**
   - Primary key: id
   - Unique: title
   - Upsert pattern: ON CONFLICT DO UPDATE
   - Global reference table (no client isolation)

3. **panel_physicians table:**
   - Primary key: id
   - location, file_url, file_name, file_type
   - Global reference table

4. **audit_logs table:**
   - Primary key: id
   - entity_type, entity_id (string refs, not FKs)
   - action_type: CREATE, UPDATE, DELETE, STATUS_CHANGE
   - performed_by (JSON object)
   - old_data, new_data, changes_diff (JSON)
   - No FK constraints (logs all entities generically)
  </action>
  <verify>
Read secure-form-links, job-positions, panel-physicians, audit-logs routes. Confirm:
- Upsert patterns documented
- Audit logging structure clear
  </verify>
  <done>
All remaining tables audited.
  </done>
</task>

<task type="auto">
  <name>Task 3: Complete Phase 3 verification and document findings</name>
  <files></files>
  <action>
Review all Phase 3 audit findings:

1. **Read all 03-XX-SUMMARY.md files**

2. **Compile complete database integrity report:**

   **Tables by category:**
   - Core (4): admin_users, user_client_roles, clients, employees
   - Investigation (5): incidents, interviews, interview_witnesses, root_cause_analysis, corrective_actions
   - Forms (9): benefit_affidavits, medical_authorizations, refusal_of_treatments, prescription_cards, modified_duty_policies, status_logs, status_log_entries, mileage_reimbursements, trip_entries
   - Ancillary (8): evidence, messages, push_tokens, push_subscriptions, secure_form_links, job_positions, panel_physicians, audit_logs
   - Total: 27 tables

3. **Summary of findings:**
   - All verified FK relationships
   - All missing FK constraints
   - All cascade/orphan risks
   - All missing indexes (recommendations)

4. **Critical issues for Phase 10:**
   - No soft delete pattern
   - Missing ON DELETE CASCADE
   - corrective_actions.assignee_id not constrained
   - evidence.uploaded_by not constrained

5. **Overall database health assessment**

6. **Impact on workflow phases (4-9):**
   - Any issues that will affect workflow verification?
   - Recommendations for handling
  </action>
  <verify>
All previous plan summaries exist and document findings.
  </verify>
  <done>
Phase 3: Database Integrity Audit complete. All 27 tables audited.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] evidence, messages tables audited
- [ ] push_tokens, push_subscriptions audited
- [ ] secure_form_links audited
- [ ] job_positions, panel_physicians audited
- [ ] audit_logs structure documented
- [ ] All Phase 3 findings compiled
- [ ] Overall database health assessed
</verification>

<success_criteria>

- All 27 tables audited
- All FK relationships verified or gaps documented
- Cascade risks identified
- Phase 3: Database Integrity COMPLETE
- Ready for workflow phases (4-9)
</success_criteria>

<output>
After completion, create `.planning/phases/03-database-integrity/03-04-SUMMARY.md` with:
- Remaining table audit findings
- Complete Phase 3 summary (all 27 tables)
- FK relationship map
- Missing constraints and risks
- Recommendations for Phase 10
- Confirmation: Phase 3 complete
</output>
