---
phase: 03-database-integrity
plan: 02
type: execute
depends_on: []
files_modified: []
---

<objective>
Audit incident and investigation tables: incidents, interviews, interview_witnesses, root_cause_analysis, corrective_actions.

Purpose: Verify foreign key relationships and constraints for the incident investigation workflow.
Output: Audit findings for investigation tables documented.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Tables to audit:**
- incidents (id, incident_number, employee_id, client_id, incident_date, status, priority, severity, etc.)
- interviews (id, incident_id, employee_id, interviewee_name, type, status, etc.)
- interview_witnesses (id, interview_id, witness_name, witness_role)
- root_cause_analysis (id, incident_id, why_level 1-5, question, answer, finalized)
- corrective_actions (id, incident_id, title, assignee_id, due_date, status, priority_level)

**Key API files:**
@apps/web/src/app/api/incidents/route.js
@apps/web/src/app/api/incidents/[id]/route.js
@apps/web/src/app/api/interviews/route.js
@apps/web/src/app/api/interviews/[id]/route.js
@apps/web/src/app/api/interview-witnesses/route.js
@apps/web/src/app/api/root-cause-analysis/route.js
@apps/web/src/app/api/corrective-actions/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit incidents table</name>
  <files>apps/web/src/app/api/incidents/route.js, apps/web/src/app/api/incidents/[id]/route.js</files>
  <action>
Read and verify:

1. **incidents table:**
   - Primary key: id
   - incident_number: auto-generated, unique?
   - Foreign keys: employee_id → employees(id), client_id → clients(id)
   - Both FKs nullable (verify queries handle nulls)

2. **Enum/Check constraints:**
   - status: open, draft, submitted
   - priority: low, medium, high
   - severity: critical, high, medium, low
   - Verify validation in POST/PUT

3. **Special fields:**
   - body_parts_injured: array type
   - analysis_data: JSON type
   - Verify these handle null/empty properly

4. **Delete behavior:**
   - This is the main parent for 10+ child tables
   - Document cascade risk (no soft delete)
   - List all dependent tables

5. **Client isolation:**
   - Verify client_ids filtering in GET
   - Verify JOIN patterns
  </action>
  <verify>
Read incidents routes. Confirm:
- FK relationships clear
- Status/priority validation
- Client isolation implemented
  </verify>
  <done>
incidents table audited with all findings documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit interviews and witnesses tables</name>
  <files>apps/web/src/app/api/interviews/route.js, apps/web/src/app/api/interview-witnesses/route.js</files>
  <action>
Read and verify:

1. **interviews table:**
   - Primary key: id
   - Foreign key: incident_id → incidents(id) (required)
   - Foreign key: employee_id → employees(id) (optional - interviewee may not be employee)
   - status: pending, draft
   - Boolean fields: wearing_ppe, area_adequately_lit, witnessed_directly

2. **interview_witnesses table:**
   - Primary key: id
   - Foreign key: interview_id → interviews(id)
   - Verify cascade behavior on interview delete

3. **Query patterns:**
   - Check if witnesses fetched with interview (JOIN) or separately (N+1)
   - Document pattern used
  </action>
  <verify>
Read interview routes. Confirm:
- incident_id FK required
- Witness relationship clear
  </verify>
  <done>
interviews and interview_witnesses tables audited.
  </done>
</task>

<task type="auto">
  <name>Task 3: Audit root_cause_analysis and corrective_actions tables</name>
  <files>apps/web/src/app/api/root-cause-analysis/route.js, apps/web/src/app/api/corrective-actions/route.js</files>
  <action>
Read and verify:

1. **root_cause_analysis table:**
   - Primary key: id
   - Foreign key: incident_id → incidents(id)
   - why_level: 1-5 (Five-Why methodology)
   - finalized: boolean
   - Verify multiple entries per incident allowed

2. **corrective_actions table:**
   - Primary key: id
   - Foreign key: incident_id → incidents(id)
   - assignee_id: should reference employees but may not be constrained
   - status: open, draft
   - priority_level: enum?

3. **Missing constraints:**
   - Document if assignee_id lacks FK constraint
   - Document any validation gaps

4. **Compile investigation audit summary:**
   - All verified FKs
   - All missing FKs
   - Cascade risks
  </action>
  <verify>
Read root-cause and corrective-actions routes. Confirm:
- incident_id FK present
- Status validation exists
  </verify>
  <done>
Investigation tables fully audited. Plan 02 complete.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] incidents table audited (FKs, enums, array/JSON fields)
- [ ] interviews table audited (incident_id FK)
- [ ] interview_witnesses audited (interview_id FK)
- [ ] root_cause_analysis audited
- [ ] corrective_actions audited (including assignee_id gap)
</verification>

<success_criteria>

- All 5 investigation tables audited
- FK relationships verified or gaps documented
- Cascade risks from incident delete identified
- No critical blocking issues
</success_criteria>

<output>
After completion, create `.planning/phases/03-database-integrity/03-02-SUMMARY.md` with:
- Audit findings for each table
- FK verification results
- Cascade risks
- Recommendations
</output>
