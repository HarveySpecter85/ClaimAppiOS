---
phase: 03-database-integrity
plan: 01
type: execute
depends_on: []
files_modified: []
---

<objective>
Audit core user and client tables: admin_users, user_client_roles, clients, employees.

Purpose: Verify foreign key relationships, constraints, and data integrity for the foundational tables.
Output: Audit findings for core tables documented.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Database context:**
- PostgreSQL (Neon Serverless)
- SQL utility: apps/web/src/app/api/utils/sql.js
- No migration files in repo - schema managed externally

**Core tables to audit:**
- admin_users (id, name, email, role, system_role, avatar_url, created_at)
- user_client_roles (id, user_id, client_id, company_role, assigned_by, created_at)
- clients (id, name, location, address, contact_*, manager_*, safety_coordinator_*, logo_url, colors, timestamps)
- employees (id, full_name, employee_id, job_position, client_id, timestamps)

**Key API files:**
@apps/web/src/app/api/admin-users/route.js
@apps/web/src/app/api/admin-users/[id]/route.js
@apps/web/src/app/api/admin-users/[id]/client-roles/route.js
@apps/web/src/app/api/clients/route.js
@apps/web/src/app/api/clients/[id]/route.js
@apps/web/src/app/api/employees/route.js
@apps/web/src/app/api/employees/[id]/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit admin_users and user_client_roles tables</name>
  <files>apps/web/src/app/api/admin-users/route.js, apps/web/src/app/api/admin-users/[id]/client-roles/route.js, apps/web/src/app/api/utils/auth.js</files>
  <action>
Read and verify:

1. **admin_users table:**
   - Primary key: id
   - Unique constraint: email (case-insensitive - verify LOWER() used in queries)
   - NOT NULL: email, name
   - Valid system_role values: global_admin, standard (verify validation in POST/PUT)

2. **user_client_roles table:**
   - Composite unique: (user_id, client_id)
   - Foreign keys: user_id → admin_users(id), client_id → clients(id)
   - assigned_by references admin_users
   - Check for orphaned records risk on user/client delete

3. **Query patterns:**
   - Verify LEFT JOIN usage for optional relationships
   - Verify client_ids array properly populated in auth.js
   - Check for N+1 queries in role fetching

Document findings. Note any missing constraints or risks.
  </action>
  <verify>
Read admin-users routes and auth.js. Confirm:
- Email uniqueness enforced
- Role validation exists
- Client roles properly joined
  </verify>
  <done>
admin_users and user_client_roles tables audited with findings documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit clients table</name>
  <files>apps/web/src/app/api/clients/route.js, apps/web/src/app/api/clients/[id]/route.js</files>
  <action>
Read and verify:

1. **clients table:**
   - Primary key: id
   - NOT NULL: name (minimum required)
   - Timestamps: created_at, updated_at

2. **Delete behavior:**
   - Check what happens when client deleted
   - Look for CASCADE or orphan risk with employees, incidents, user_client_roles
   - Document if DELETE is unrestricted

3. **Query patterns:**
   - Verify client isolation in GET queries
   - Check for proper WHERE clauses with user.client_ids

Document findings.
  </action>
  <verify>
Read clients route. Confirm:
- Basic CRUD implemented
- Delete risks documented
  </verify>
  <done>
clients table audited with cascade/orphan risks documented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Audit employees table and complete plan</name>
  <files>apps/web/src/app/api/employees/route.js, apps/web/src/app/api/employees/[id]/route.js</files>
  <action>
Read and verify:

1. **employees table:**
   - Primary key: id
   - Foreign key: client_id → clients(id)
   - Verify FK constraint exists (or document if missing)
   - NOT NULL: full_name, client_id (verify)

2. **Delete behavior:**
   - Check what happens when employee deleted
   - Look for CASCADE or orphan risk with incidents, interviews, status_logs
   - Document if DELETE is unrestricted

3. **Query patterns:**
   - Verify LEFT JOIN with clients for client_name
   - Verify client isolation filtering
   - Check for N+1 patterns

4. **Compile audit summary:**
   - List all verified constraints
   - List all missing constraints
   - List all cascade/orphan risks
   - Recommendations for Phase 10 fixes (if any)
  </action>
  <verify>
Read employees route. Confirm:
- client_id relationship verified
- Delete risks documented
  </verify>
  <done>
Core tables (admin_users, user_client_roles, clients, employees) fully audited.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] admin_users table audited (constraints, validation)
- [ ] user_client_roles composite key verified
- [ ] clients table audited (delete risks)
- [ ] employees table audited (FK to clients, delete risks)
- [ ] All findings documented
</verification>

<success_criteria>

- All 4 core tables audited
- Foreign key relationships verified or gaps documented
- Cascade/orphan risks identified
- No critical issues blocking workflow phases
</success_criteria>

<output>
After completion, create `.planning/phases/03-database-integrity/03-01-SUMMARY.md` with:
- Audit findings for each table
- Constraints verified
- Missing constraints or risks
- Recommendations
</output>
