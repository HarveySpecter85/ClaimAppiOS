---
phase: 03-database-integrity
plan: 03
type: execute
depends_on: []
files_modified: []
---

<objective>
Audit form and documentation tables: benefit_affidavits, medical_authorizations, refusal_of_treatments, prescription_cards, modified_duty_policies, status_logs, status_log_entries, mileage_reimbursements, trip_entries.

Purpose: Verify foreign key relationships for all incident-related forms.
Output: Audit findings for form tables documented.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Form tables (all link to incidents):**
- benefit_affidavits (incident_id FK)
- medical_authorizations (incident_id FK)
- refusal_of_treatments (incident_id FK)
- prescription_cards (incident_id FK)
- modified_duty_policies (incident_id FK)

**Status tracking tables:**
- status_logs (incident_id FK, employee_id FK)
- status_log_entries (status_log_id FK)

**Mileage tables:**
- mileage_reimbursements (incident_id FK, employee_id FK)
- trip_entries (reimbursement_id FK)

**Key API files:**
@apps/web/src/app/api/benefit-affidavits/route.js
@apps/web/src/app/api/medical-authorizations/route.js
@apps/web/src/app/api/refusal-of-treatments/route.js
@apps/web/src/app/api/prescription-cards/route.js
@apps/web/src/app/api/modified-duty-policies/route.js
@apps/web/src/app/api/status-logs/route.js
@apps/web/src/app/api/status-log-entries/route.js
@apps/web/src/app/api/mileage-reimbursements/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit form tables (benefit, medical, refusal, prescription, modified duty)</name>
  <files>apps/web/src/app/api/benefit-affidavits/route.js, apps/web/src/app/api/medical-authorizations/route.js, apps/web/src/app/api/refusal-of-treatments/route.js, apps/web/src/app/api/prescription-cards/route.js, apps/web/src/app/api/modified-duty-policies/route.js</files>
  <action>
Read and verify each form table:

1. **Common pattern for all form tables:**
   - Primary key: id
   - Foreign key: incident_id → incidents(id)
   - status field with draft/pending values
   - Timestamps: created_at, updated_at

2. **For each table, verify:**
   - incident_id FK is required (NOT NULL)
   - Status validation in POST/PUT
   - Signature URL fields present
   - Boolean consent/authorization fields

3. **Specific validations:**
   - benefit_affidavits: date_signed, employee_signature_url
   - medical_authorizations: include_hiv_aids, include_mental_health, include_drug_alcohol booleans
   - prescription_cards: consent boolean
   - modified_duty_policies: decision enum (accept, decline)

4. **Document any missing validations or FK constraints.**
  </action>
  <verify>
Read each form route. Confirm:
- incident_id required
- Status validation exists
  </verify>
  <done>
5 form tables audited.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit status_logs and status_log_entries tables</name>
  <files>apps/web/src/app/api/status-logs/route.js, apps/web/src/app/api/status-log-entries/route.js</files>
  <action>
Read and verify:

1. **status_logs table:**
   - Primary key: id
   - Foreign keys: incident_id → incidents(id), employee_id → employees(id)
   - week_ending date field
   - Verify both FKs required or optional

2. **status_log_entries table:**
   - Primary key: id
   - Foreign key: status_log_id → status_logs(id)
   - entry_date, pain_scale, hours_worked fields
   - Verify FK constraint exists

3. **Parent-child relationship:**
   - status_logs → status_log_entries (1:many)
   - Verify entries fetched with log or separately
   - Document cascade behavior
  </action>
  <verify>
Read status-logs routes. Confirm:
- Parent-child FK relationship clear
- Entries linked to logs
  </verify>
  <done>
status_logs and status_log_entries tables audited.
  </done>
</task>

<task type="auto">
  <name>Task 3: Audit mileage_reimbursements and trip_entries tables</name>
  <files>apps/web/src/app/api/mileage-reimbursements/route.js</files>
  <action>
Read and verify:

1. **mileage_reimbursements table:**
   - Primary key: id
   - Foreign keys: incident_id → incidents(id), employee_id → employees(id)
   - employee_signature_url, date_signed, status

2. **trip_entries table:**
   - Primary key: id
   - Foreign key: reimbursement_id → mileage_reimbursements(id)
   - trip_date, start_address, medical_facility, round_trip_miles

3. **Insertion pattern:**
   - Check if trip entries inserted in loop (N+1) or batch
   - Document pattern used

4. **Compile form tables audit summary:**
   - All 9 form-related tables verified
   - FK relationships documented
   - Any gaps or risks
  </action>
  <verify>
Read mileage-reimbursements route. Confirm:
- Trip entries linked to reimbursement
- Insertion pattern documented
  </verify>
  <done>
All 9 form/documentation tables audited. Plan 03 complete.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] 5 form tables audited (benefit, medical, refusal, prescription, modified duty)
- [ ] status_logs and status_log_entries audited
- [ ] mileage_reimbursements and trip_entries audited
- [ ] All incident_id FKs verified
- [ ] Parent-child relationships documented
</verification>

<success_criteria>

- All 9 form/documentation tables audited
- FK relationships verified
- No critical gaps blocking workflow phases
</success_criteria>

<output>
After completion, create `.planning/phases/03-database-integrity/03-03-SUMMARY.md` with:
- Audit findings for each table
- FK verification results
- Recommendations
</output>
