# Plan 04-03: Audit Client Access Enforcement

## Objective
Verify client isolation is enforced after role assignment

## Scope
Audit only - document findings for Phase 10 fixes

---

## Tasks

### Task 1: Audit requireRole() Client Population
**Files**: `apps/web/src/app/api/utils/auth.js`

- [ ] Verify client_roles fetched from user_client_roles table
- [ ] Verify client_ids array populated correctly
- [ ] Verify global_admin bypass behavior
- [ ] Document the client access flow

### Task 2: Audit Working vs Broken Endpoints
**Files**: `apps/web/src/app/api/incidents/route.js`, `apps/web/src/app/api/incidents/[id]/route.js`

- [ ] Document working pattern: GET /incidents uses client_ids filter
- [ ] Document broken pattern: GET /incidents/[id] has no client check
- [ ] Compare implementation differences
- [ ] Document the fix pattern needed

### Task 3: Compile Client Isolation Gap List
**Output**: Complete gap inventory from Phase 3 + new findings

- [ ] List all 11 endpoints from Phase 3 missing client isolation
- [ ] Categorize by severity (critical/high/medium)
- [ ] Document exploitation risk for each
- [ ] Create prioritized fix recommendations for Phase 10

---

## Files to Read

```
apps/web/src/app/api/utils/auth.js
apps/web/src/app/api/incidents/route.js
apps/web/src/app/api/incidents/[id]/route.js
apps/web/src/app/api/clients/route.js
apps/web/src/app/api/evidence/route.js
apps/web/src/app/api/messages/route.js
```

## Files to Modify
None (audit only - creates SUMMARY.md)

---

## Verification
- [ ] requireRole() client population verified
- [ ] Working vs broken patterns documented
- [ ] All client isolation gaps catalogued
- [ ] SUMMARY.md created with findings
