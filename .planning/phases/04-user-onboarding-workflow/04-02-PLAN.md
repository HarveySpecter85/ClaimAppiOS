# Plan 04-02: Audit Role Assignment Flow

## Objective
Verify role assignment from admin → user → client mapping

## Scope
Audit only - document findings for Phase 10 fixes

---

## Tasks

### Task 1: Audit Client-Roles API
**Files**: `apps/web/src/app/api/admin-users/[id]/client-roles/route.js`

- [ ] Verify POST assigns user to client with company_role
- [ ] Verify upsert pattern (ON CONFLICT DO UPDATE)
- [ ] Verify DELETE removes role correctly
- [ ] Verify global_admin requirement enforced
- [ ] Check assigned_by populated from JWT (not headers)

### Task 2: Audit Role Assignment UI
**Files**: `apps/web/src/app/settings/users/page.jsx`

- [ ] Verify ClientRolesManager component behavior
- [ ] Check role assignment workflow from UI perspective
- [ ] Document user experience for role assignment

### Task 3: Document company_role Usage
**Output**: Analysis of role enforcement

- [ ] Document company_role values ("user" vs "admin")
- [ ] Check if company_role enforced anywhere in codebase
- [ ] Document assigned_by cascade risk if admin deleted
- [ ] Create recommendations for Phase 10

---

## Files to Read

```
apps/web/src/app/api/admin-users/[id]/client-roles/route.js
apps/web/src/app/settings/users/page.jsx
apps/web/src/components/RoleGuard.jsx
```

## Files to Modify
None (audit only - creates SUMMARY.md)

---

## Verification
- [ ] Client-roles API verified working
- [ ] Role assignment flow documented
- [ ] company_role enforcement gap documented
- [ ] SUMMARY.md created with findings
