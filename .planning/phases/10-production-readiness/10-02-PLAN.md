# Plan 10-02: Navigation & Error Fixes (P1)

## Objective
Fix blocking navigation and error handling issues

## Scope
Implementation - Create missing pages and fix routes

---

## Files to Create/Modify

**Create**:
- `apps/web/src/app/incidents/page.jsx`
- `apps/web/src/app/not-found.jsx`
- `apps/web/src/app/error.jsx`

**Modify**:
- `apps/mobile/src/app/(tabs)/incident/[id].jsx`
- `apps/web/src/app/api/incidents/[id]/route.js`

---

## Tasks

### Task 1: Create /incidents Page

**Location**: `apps/web/src/app/incidents/page.jsx`

**Pattern**: Based on `apps/web/src/app/reviews/page.jsx`

**Requirements**:
1. List all incidents (filtered by client for non-admins)
2. Show incident number, date, type, severity, status
3. Link to dossier view for each incident
4. Search/filter functionality
5. Proper authentication via requireRole

**Commit**: `feat(10-02): create incidents list page`

---

### Task 2: Create Root 404 Page

**Location**: `apps/web/src/app/not-found.jsx`

**Requirements**:
1. User-friendly "Page Not Found" message
2. Link back to dashboard
3. Consistent styling with app design
4. Export as default function component

**Pattern**:
```jsx
export default function NotFound() {
  return (
    <div className="flex flex-col items-center justify-center min-h-screen">
      <h1 className="text-4xl font-bold">404</h1>
      <p className="text-gray-600 mt-2">Page not found</p>
      <Link href="/" className="mt-4 text-blue-600 hover:underline">
        Return to Dashboard
      </Link>
    </div>
  );
}
```

**Commit**: `feat(10-02): create root 404 not-found page`

---

### Task 3: Create Error Boundary Page

**Location**: `apps/web/src/app/error.jsx`

**Requirements**:
1. React Router v7 error boundary component
2. Show user-friendly error message
3. "Try again" button to reset
4. Log error details (console for now)
5. Export ErrorBoundary component

**Pattern**:
```jsx
"use client";
import { useRouteError, Link } from "react-router";

export function ErrorBoundary() {
  const error = useRouteError();
  console.error("Route error:", error);

  return (
    <div className="flex flex-col items-center justify-center min-h-screen">
      <h1 className="text-4xl font-bold text-red-600">Something went wrong</h1>
      <p className="text-gray-600 mt-2">An unexpected error occurred</p>
      <Link href="/" className="mt-4 text-blue-600 hover:underline">
        Return to Dashboard
      </Link>
    </div>
  );
}
```

**Commit**: `feat(10-02): create error boundary page`

---

### Task 4: Fix Interview Route Path

**Location**: `apps/mobile/src/app/(tabs)/incident/[id].jsx:171`

**Current Code**: `router.push(\`/interview/${id}\`)`

**Fix**: `router.push(\`/(tabs)/interview/${id}\`)`

**Reason**: The interview route is defined under (tabs), so navigation must include the group prefix.

**Commit**: `fix(10-02): correct interview route path in incident detail`

---

### Task 5: Use Server-Side Timestamp for reviewed_at

**Location**: `apps/web/src/app/api/incidents/[id]/route.js`

**Current Issue**: Frontend sends reviewed_at, which can be manipulated

**Fix**:
1. Ignore body.reviewed_at from request
2. Set reviewed_at = new Date().toISOString() in API
3. Ensure timestamp reflects actual server time

**Commit**: `fix(10-02): use server-side timestamp for reviewed_at`

---

### Task 6: Add Reviewer Role Enforcement

**Location**: `apps/web/src/app/api/incidents/[id]/route.js` (PATCH handler)

**Current Issue**: Any authenticated user can approve/reject

**Fix**:
1. Check if status change is approval/rejection
2. Verify user has reviewer/admin role
3. Return 403 if not authorized

**Commit**: `fix(10-02): enforce reviewer role for incident approval`

---

## Success Criteria

- [ ] /incidents page loads with incident list
- [ ] 404 page displays for unknown routes
- [ ] Error boundary catches and displays errors
- [ ] Mobile interview navigation works
- [ ] reviewed_at uses server timestamp
- [ ] Only reviewers can approve/reject
- [ ] All changes committed

---

## Verification

After completing tasks:
1. Navigate to /incidents - should show incident list
2. Navigate to /nonexistent - should show 404 page
3. Trigger error in component - should show error boundary
4. On mobile, tap interview button - should navigate correctly
5. Approve incident - check reviewed_at is server time
6. Try approve as non-reviewer - should get 403
