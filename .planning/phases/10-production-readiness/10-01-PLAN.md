# Plan 10-01: Critical Security Fixes (P0)

## Objective
Fix all P0 security and data integrity issues deferred from Phases 1-9

## Scope
Implementation - Fix critical issues before launch

---

## Files to Modify

- `apps/web/src/app/reviews/[id]/page.jsx`
- `apps/web/src/app/api/incidents/route.js`
- `apps/web/src/app/api/dashboard/stats/route.js`
- `apps/mobile/src/context/SyncContext.jsx`
- Form POST routes (8 files)
- Legal document routes (affidavit, refusal, medical auth)

---

## Tasks

### Task 1: Fix reviewed_by Hardcoding

**Location**: `apps/web/src/app/reviews/[id]/page.jsx:48`

**Current Code**: `reviewed_by: 1` (hardcoded)

**Fix**:
1. Get user session/ID from authentication context
2. Pass real user ID to reviewed_by field
3. Ensure audit trail shows actual reviewer

**Commit**: `fix(10-01): use authenticated user ID for reviewed_by`

---

### Task 2: Add Client Isolation to Dashboard

**Location**: `apps/web/src/app/api/dashboard/stats/route.js`

**Current Issue**: Dashboard shows ALL incidents to any authenticated user

**Fix**:
1. Add `requireRole()` to get user info
2. Extract client_id from user's role assignments
3. Filter all stats queries by client_id
4. Global admins can see all, others see only their client

**Commit**: `fix(10-01): add client isolation to dashboard stats`

---

### Task 3: Remove client_id Fallback to 1

**Location**: `apps/web/src/app/api/incidents/route.js:124`

**Current Code**: `client_id: employeeData.client_id || 1`

**Fix**:
1. Remove `|| 1` fallback
2. Validate client_id is present and valid
3. Return 400 error if missing: `{ error: "client_id is required" }`

**Commit**: `fix(10-01): require valid client_id for incident creation`

---

### Task 4: Add Employee Deduplication in Sync

**Location**: `apps/mobile/src/context/SyncContext.jsx:69-84`

**Current Issue**: Retry creates duplicate employees

**Fix**:
1. Before creating employee, check if exists by (full_name + client_id)
2. If exists, use existing employee_id
3. If not, create new employee
4. Store employeeId in queue item for retry reuse

**Commit**: `fix(10-01): add employee deduplication during sync`

---

### Task 5: Add Required Field Validation to Forms

**Location**: All 8 form POST routes

**Forms**:
- benefit-affidavits, medical-authorizations, prescription-cards
- mileage-reimbursements, modified-duty-policies, refusal-of-treatments
- status-logs, forms

**Fix**:
1. Define required fields for each form type
2. Validate at start of POST handler
3. Return 400 with specific field errors

**Commit**: `fix(10-01): add required field validation to form POST routes`

---

### Task 6: Require Signatures for Legal Documents

**Location**: Affidavit, refusal, medical auth POST routes

**Legal docs requiring signatures**:
- benefit-affidavits: employee_signature, witness_signature
- refusal-of-treatments: employee_signature
- medical-authorizations: employee_signature

**Fix**:
1. Check signature fields are not empty/null
2. Return 400 if signature missing
3. Message: "Signature is required for this document"

**Commit**: `fix(10-01): require signatures for legal documents`

---

### Task 7: Extract Audit Performer from JWT

**Location**: All API routes that log audits

**Current Issue**: `body.performed_by_user` can be spoofed from frontend

**Fix**:
1. Get user ID from requireRole() return value
2. Use that ID for audit logging, not body value
3. Ensure audit trail cannot be manipulated

**Commit**: `fix(10-01): extract audit performer from JWT not request body`

---

## Success Criteria

- [ ] reviewed_by uses real user ID
- [ ] Dashboard filters by client_id
- [ ] client_id validation rejects null/undefined
- [ ] Employee deduplication prevents duplicates
- [ ] Form POST routes validate required fields
- [ ] Legal docs require signatures
- [ ] Audit performer comes from JWT
- [ ] All changes committed

---

## Verification

After completing tasks:
1. Test review approval - check reviewed_by is logged correctly
2. Test dashboard as non-admin - should only see own client's data
3. Test incident creation without client_id - should get 400
4. Test offline sync retry - should not create duplicate employee
5. Test form submission without required fields - should get 400
6. Test legal doc submission without signature - should get 400
