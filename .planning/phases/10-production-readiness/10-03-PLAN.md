# Plan 10-03: Production Infrastructure

## Objective
Add essential production infrastructure

## Scope
Implementation - Create deployment essentials

---

## Files to Create/Modify

**Create**:
- `apps/web/.env.example`
- `apps/mobile/.env.example`
- `apps/web/src/app/api/health/route.js`
- `.github/workflows/ci.yml`

**Modify**:
- `apps/web/__create/index.ts` (security headers)
- `apps/web/src/app/api/auth/login/route.js` (rate limiting)

---

## Tasks

### Task 1: Create .env.example Files

**Web** (`apps/web/.env.example`):
```env
# Database
DATABASE_URL=postgresql://user:password@host:5432/database

# Authentication
AUTH_SECRET=your-secret-key-min-32-chars
AUTH_URL=https://your-domain.com

# CORS (comma-separated origins)
CORS_ORIGINS=https://your-domain.com,https://app.your-domain.com

# Create.xyz Integration
NEXT_PUBLIC_CREATE_API_BASE_URL=https://api.create.xyz
NEXT_PUBLIC_PROJECT_GROUP_ID=your-project-id
CREATE_TEMP_API_KEY=your-api-key

# Optional: Stripe
STRIPE_SECRET_KEY=sk_live_xxx
```

**Mobile** (`apps/mobile/.env.example`):
```env
# API Configuration
EXPO_PUBLIC_API_URL=https://api.your-domain.com

# Uploadcare
EXPO_PUBLIC_UPLOADCARE_PUBLIC_KEY=your-public-key

# Error Reporting
EXPO_PUBLIC_LOGS_ENDPOINT=https://your-logging-service.com

# Push Notifications (Expo)
EXPO_PUBLIC_PROJECT_ID=your-expo-project-id
```

**Commit**: `chore(10-03): add .env.example files for web and mobile`

---

### Task 2: Add Health Check Endpoint

**Location**: `apps/web/src/app/api/health/route.js`

**Requirements**:
1. No authentication required
2. Check database connectivity
3. Return JSON with status, timestamp, db status
4. Return 200 if healthy, 503 if unhealthy

**Implementation**:
```javascript
import sql from "../utils/sql";

export async function GET() {
  try {
    // Test database connection
    await sql`SELECT 1`;

    return Response.json({
      status: "ok",
      timestamp: new Date().toISOString(),
      database: "connected",
      version: process.env.npm_package_version || "unknown"
    });
  } catch (error) {
    return Response.json({
      status: "error",
      timestamp: new Date().toISOString(),
      database: "disconnected",
      error: error.message
    }, { status: 503 });
  }
}
```

**Commit**: `feat(10-03): add health check endpoint`

---

### Task 3: Add Security Headers Middleware

**Location**: `apps/web/__create/index.ts`

**Headers to add**:
```javascript
// Add after CORS middleware
app.use("*", async (c, next) => {
  await next();
  // Security headers
  c.header("X-Content-Type-Options", "nosniff");
  c.header("X-Frame-Options", "DENY");
  c.header("X-XSS-Protection", "1; mode=block");
  c.header("Referrer-Policy", "strict-origin-when-cross-origin");
  c.header("Permissions-Policy", "camera=(), microphone=(), geolocation=()");
});
```

**Commit**: `feat(10-03): add security headers middleware`

---

### Task 4: Add Basic Rate Limiting

**Location**: `apps/web/src/app/api/auth/login/route.js`

**Implementation** (simple in-memory for MVP):
```javascript
const loginAttempts = new Map();
const RATE_LIMIT = 10; // attempts
const RATE_WINDOW = 60000; // 1 minute

function checkRateLimit(ip) {
  const now = Date.now();
  const attempts = loginAttempts.get(ip) || [];
  const recentAttempts = attempts.filter(t => now - t < RATE_WINDOW);

  if (recentAttempts.length >= RATE_LIMIT) {
    return false;
  }

  recentAttempts.push(now);
  loginAttempts.set(ip, recentAttempts);
  return true;
}

// At start of POST handler:
const ip = request.headers.get("x-forwarded-for") || "unknown";
if (!checkRateLimit(ip)) {
  return Response.json({ error: "Too many login attempts. Try again later." }, { status: 429 });
}
```

**Commit**: `feat(10-03): add rate limiting to login endpoint`

---

### Task 5: Create CI Workflow

**Location**: `.github/workflows/ci.yml`

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npm run typecheck --workspaces --if-present

      - name: Build web
        run: npm run build --workspace=apps/web
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
```

**Commit**: `chore(10-03): add GitHub Actions CI workflow`

---

### Task 6: Add Startup Environment Validation

**Location**: `apps/web/__create/index.ts` or server entry

**Implementation**:
```javascript
// At server startup
const requiredEnvVars = [
  "DATABASE_URL",
  "AUTH_SECRET"
];

for (const envVar of requiredEnvVars) {
  if (!process.env[envVar]) {
    console.error(`Missing required environment variable: ${envVar}`);
    process.exit(1);
  }
}
```

**Commit**: `feat(10-03): add startup environment validation`

---

## Success Criteria

- [ ] .env.example files created for both apps
- [ ] /api/health returns 200 with status JSON
- [ ] Security headers present in responses
- [ ] Login rate limiting blocks after 10 attempts
- [ ] CI workflow runs on push/PR
- [ ] Server fails fast if required env vars missing
- [ ] All changes committed

---

## Verification

After completing tasks:
1. Check .env.example files have all variables documented
2. GET /api/health - should return status JSON
3. Check response headers - should include X-Frame-Options, etc.
4. Attempt 11 rapid logins - should get 429 on 11th
5. Push to GitHub - CI should run
6. Start server without DATABASE_URL - should exit with error
