---
phase: 01-security-hardening
plan: 02
type: execute
depends_on: ["01-01"]
files_modified: [
  apps/web/src/app/api/clients/route.js,
  apps/web/src/app/api/employees/route.js,
  apps/web/src/app/api/admin-users/route.js,
  apps/web/src/app/api/audit-logs/route.js,
  apps/web/src/app/api/job-positions/route.js,
  apps/web/src/app/api/messages/route.js
]
---

<objective>
Add authentication to core entity API routes (clients, employees, admin-users, audit-logs, job-positions, messages).

Purpose: Prevent unauthorized access to core business data.
Output: All core entity routes require valid JWT and appropriate role.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Auth pattern (from incidents/route.js):**
```javascript
import { requireRole } from "@/app/api/utils/auth";

export async function GET(request) {
  const { authorized, response, user } = await requireRole(request, []);
  if (!authorized) return response;
  // ... rest of handler
}
```

**Role guidance:**
- `requireRole(request, [])` - Any authenticated user
- `requireRole(request, ["global_admin"])` - Global admins only
- `requireRole(request, ["global_admin", "standard"])` - Any system role

**Files to secure:**
1. clients/route.js - GET (any auth), POST (global_admin)
2. employees/route.js - GET (any auth), POST (any auth)
3. admin-users/route.js - All methods (global_admin only)
4. audit-logs/route.js - GET (global_admin only)
5. job-positions/route.js - GET (any auth), POST (any auth)
6. messages/route.js - GET/POST (any auth)

@apps/web/src/app/api/utils/auth.js
@apps/web/src/app/api/incidents/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Secure clients and employees routes</name>
  <files>apps/web/src/app/api/clients/route.js, apps/web/src/app/api/employees/route.js</files>
  <action>
**clients/route.js:**
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. Wrap GET handler:
   - Add auth check at start: `const { authorized, response, user } = await requireRole(request, []);`
   - Add early return: `if (!authorized) return response;`
3. Wrap POST handler:
   - Add auth check requiring global_admin: `const { authorized, response } = await requireRole(request, ["global_admin"]);`
   - Add early return: `if (!authorized) return response;`

**employees/route.js:**
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. Wrap GET handler with any-auth check
3. Wrap POST handler with any-auth check

Follow the exact pattern from incidents/route.js. Do NOT modify the existing SQL queries or response logic.
  </action>
  <verify>
Read both files and confirm:
- Import statement present
- GET has requireRole check
- POST has requireRole check
- Original SQL and response logic unchanged
  </verify>
  <done>
clients/route.js and employees/route.js require authentication on all methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Secure admin-users and audit-logs routes</name>
  <files>apps/web/src/app/api/admin-users/route.js, apps/web/src/app/api/audit-logs/route.js</files>
  <action>
**admin-users/route.js:**
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. ALL methods (GET, POST, PUT, DELETE if present) require global_admin:
   - `const { authorized, response } = await requireRole(request, ["global_admin"]);`
   - `if (!authorized) return response;`

**audit-logs/route.js:**
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. GET requires global_admin (audit logs are sensitive):
   - `const { authorized, response } = await requireRole(request, ["global_admin"]);`
   - `if (!authorized) return response;`

These are sensitive administrative resources - only global_admin should access them.
  </action>
  <verify>
Read both files and confirm:
- Import statement present
- All handlers have requireRole with ["global_admin"]
- Original logic unchanged
  </verify>
  <done>
admin-users/route.js and audit-logs/route.js restricted to global_admin only.
  </done>
</task>

<task type="auto">
  <name>Task 3: Secure job-positions and messages routes</name>
  <files>apps/web/src/app/api/job-positions/route.js, apps/web/src/app/api/messages/route.js</files>
  <action>
**job-positions/route.js:**
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. GET: any authenticated user
3. POST: any authenticated user (creating job positions is operational)

**messages/route.js:**
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. GET: any authenticated user
3. POST: any authenticated user

Use `requireRole(request, [])` for any-auth (empty array = just need valid token).
  </action>
  <verify>
Read both files and confirm:
- Import statement present
- All handlers have requireRole check
- Original logic unchanged
  </verify>
  <done>
job-positions/route.js and messages/route.js require authentication.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 6 files have `import { requireRole }` statement
- [ ] All handlers check authorization before proceeding
- [ ] admin-users and audit-logs restricted to global_admin
- [ ] No syntax errors in modified files
</verification>

<success_criteria>

- All 6 core entity routes require authentication
- Sensitive admin routes restricted to global_admin
- Original business logic unchanged
- Pattern consistent with incidents/route.js
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-02-SUMMARY.md`
</output>
