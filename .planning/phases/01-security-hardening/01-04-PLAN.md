---
phase: 01-security-hardening
plan: 04
type: execute
depends_on: ["01-02"]
files_modified: [
  apps/web/src/app/api/benefit-affidavits/route.js,
  apps/web/src/app/api/benefit-affidavits/[id]/route.js,
  apps/web/src/app/api/medical-authorizations/route.js,
  apps/web/src/app/api/medical-authorizations/[id]/route.js,
  apps/web/src/app/api/prescription-cards/route.js,
  apps/web/src/app/api/prescription-cards/[id]/route.js,
  apps/web/src/app/api/refusal-of-treatments/route.js,
  apps/web/src/app/api/refusal-of-treatments/[id]/route.js,
  apps/web/src/app/api/mileage-reimbursements/route.js,
  apps/web/src/app/api/mileage-reimbursements/[id]/route.js,
  apps/web/src/app/api/modified-duty-policies/route.js,
  apps/web/src/app/api/modified-duty-policies/[id]/route.js
]
---

<objective>
Add authentication to document and form routes (benefits, medical, prescriptions, mileage, policies).

Purpose: Secure sensitive employee and medical documentation endpoints.
Output: All document/form routes require valid JWT.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-hardening/01-02-SUMMARY.md

**Auth pattern:**
```javascript
import { requireRole } from "@/app/api/utils/auth";

export async function GET(request) {
  const { authorized, response, user } = await requireRole(request, []);
  if (!authorized) return response;
  // ... rest
}

// For [id] routes
export async function GET(request, { params }) {
  const { authorized, response, user } = await requireRole(request, []);
  if (!authorized) return response;
  const { id } = params;
  // ... rest
}
```

**All routes: any authenticated user**
</context>

<tasks>

<task type="auto">
  <name>Task 1: Secure benefit and medical routes</name>
  <files>apps/web/src/app/api/benefit-affidavits/route.js, apps/web/src/app/api/benefit-affidavits/[id]/route.js, apps/web/src/app/api/medical-authorizations/route.js, apps/web/src/app/api/medical-authorizations/[id]/route.js</files>
  <action>
For each file:
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. Wrap all handlers with:
   ```javascript
   const { authorized, response, user } = await requireRole(request, []);
   if (!authorized) return response;
   ```
3. For [id] routes, keep params after auth check

**benefit-affidavits/route.js** - GET, POST
**benefit-affidavits/[id]/route.js** - GET, PUT, DELETE
**medical-authorizations/route.js** - GET, POST
**medical-authorizations/[id]/route.js** - GET, PUT, DELETE
  </action>
  <verify>
Grep for requireRole in each file.
  </verify>
  <done>
Benefit affidavits and medical authorization routes secured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Secure prescription and treatment routes</name>
  <files>apps/web/src/app/api/prescription-cards/route.js, apps/web/src/app/api/prescription-cards/[id]/route.js, apps/web/src/app/api/refusal-of-treatments/route.js, apps/web/src/app/api/refusal-of-treatments/[id]/route.js</files>
  <action>
For each file:
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. Wrap all handlers with auth check using `requireRole(request, [])`

**prescription-cards/route.js** - GET, POST
**prescription-cards/[id]/route.js** - GET, PUT, DELETE
**refusal-of-treatments/route.js** - GET, POST
**refusal-of-treatments/[id]/route.js** - GET, PUT, DELETE
  </action>
  <verify>
Grep for requireRole in each file.
  </verify>
  <done>
Prescription cards and refusal of treatment routes secured.
  </done>
</task>

<task type="auto">
  <name>Task 3: Secure mileage and policy routes</name>
  <files>apps/web/src/app/api/mileage-reimbursements/route.js, apps/web/src/app/api/mileage-reimbursements/[id]/route.js, apps/web/src/app/api/modified-duty-policies/route.js, apps/web/src/app/api/modified-duty-policies/[id]/route.js</files>
  <action>
For each file:
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. Wrap all handlers with auth check using `requireRole(request, [])`

**mileage-reimbursements/route.js** - GET, POST
**mileage-reimbursements/[id]/route.js** - GET, PUT, DELETE
**modified-duty-policies/route.js** - GET, POST
**modified-duty-policies/[id]/route.js** - GET, PUT, DELETE
  </action>
  <verify>
Grep for requireRole in each file.
  </verify>
  <done>
Mileage reimbursement and modified duty policy routes secured.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 12 files have requireRole import
- [ ] All handlers check authorization
- [ ] No syntax errors
</verification>

<success_criteria>

- All 12 document/form routes require authentication
- Original business logic unchanged
- Consistent auth pattern
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-04-SUMMARY.md`
</output>
