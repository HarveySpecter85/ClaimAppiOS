---
phase: 01-security-hardening
plan: 01
type: execute
depends_on: []
files_modified: [apps/web/src/app/api/auth/login/route.js]
---

<objective>
Remove the hardcoded admin backdoor from the login route.

Purpose: Eliminate critical security vulnerability that allows anyone with knowledge of the backdoor credentials to gain global_admin access.
Output: Secure login route that only authenticates users via proper password verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md

**Critical issue:**
- Hardcoded backdoor at lines 27-55 in login route
- Credentials: `hrodelo@fnstaffing.com` / `admin123`
- Auto-creates or updates user to global_admin on login

**Existing auth pattern:**
- Uses argon2 for password hashing
- JWT tokens via @auth/core
- `requireRole()` utility exists in `apps/web/src/app/api/utils/auth.js`

@apps/web/src/app/api/auth/login/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove hardcoded backdoor code</name>
  <files>apps/web/src/app/api/auth/login/route.js</files>
  <action>
Remove lines 27-55 (the entire backdoor block):
- Delete the comment "--- AUTO-FIX / BACKDOOR FOR INITIAL SETUP (Temporary) ---"
- Delete the if-block that checks for `hrodelo@fnstaffing.com` and `admin123`
- Delete the associated user creation/update SQL queries
- Delete the re-fetch query after backdoor
- Delete the closing comment "---"
- Keep the normal user lookup at line 22-25 and password verification at line 57+

The login flow should be:
1. Receive email/password
2. Query user by email (existing line 22-25)
3. Verify password hash (existing line 67+)
4. Return JWT on success

Do NOT modify any other authentication logic.
  </action>
  <verify>
Read the file and confirm:
- No reference to `hrodelo@fnstaffing.com`
- No reference to `admin123`
- No conditional auto-creation of admin users
- Normal login flow preserved
  </verify>
  <done>
Backdoor code completely removed. Login route only authenticates via proper password verification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add security comment and verify login still works</name>
  <files>apps/web/src/app/api/auth/login/route.js</files>
  <action>
Add a comment near the top of the POST function (after the email/password validation):
```javascript
// SECURITY: All authentication must go through proper password verification.
// No hardcoded credentials or bypass mechanisms allowed.
```

Then verify the login route structure is correct:
1. Input validation (email + password required)
2. User lookup by email
3. Password verification via argon2
4. JWT token creation on success
5. Proper error responses (400, 401, 500)
  </action>
  <verify>
File structure is clean. Run a syntax check if available, or verify the file can be imported without errors.
  </verify>
  <done>
Login route is secure with no backdoor. Security comment added as reminder for future developers.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No reference to `hrodelo@fnstaffing.com` in codebase
- [ ] No reference to `admin123` in codebase
- [ ] Login route maintains proper argon2 password verification
- [ ] Login route returns proper JWT tokens
</verification>

<success_criteria>

- Backdoor code removed
- No hardcoded credentials in login route
- Login flow unchanged for legitimate users
- Security comment added
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-01-SUMMARY.md`
</output>
