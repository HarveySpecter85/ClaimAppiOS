---
phase: 01-security-hardening
plan: 03
type: execute
depends_on: ["01-02"]
files_modified: [
  apps/web/src/app/api/incidents/[id]/route.js,
  apps/web/src/app/api/incidents/[id]/dossier/route.js,
  apps/web/src/app/api/clients/[id]/route.js,
  apps/web/src/app/api/interviews/route.js,
  apps/web/src/app/api/interviews/[id]/route.js,
  apps/web/src/app/api/interviews/[id]/analyze/route.js,
  apps/web/src/app/api/interview-witnesses/route.js,
  apps/web/src/app/api/evidence/route.js,
  apps/web/src/app/api/corrective-actions/route.js,
  apps/web/src/app/api/corrective-actions/[id]/route.js
]
---

<objective>
Add authentication to incident-related and investigation routes.

Purpose: Secure core investigation workflows (incidents, interviews, evidence, corrective actions).
Output: All incident investigation routes require valid JWT.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-hardening/01-01-SUMMARY.md

**Auth pattern:**
```javascript
import { requireRole } from "@/app/api/utils/auth";

export async function GET(request) {
  const { authorized, response, user } = await requireRole(request, []);
  if (!authorized) return response;
  // ... rest of handler
}
```

**For routes with params (e.g., [id]):**
```javascript
export async function GET(request, { params }) {
  const { authorized, response, user } = await requireRole(request, []);
  if (!authorized) return response;
  const { id } = params;
  // ... rest of handler
}
```

**All routes in this plan: any authenticated user (operational data)**
</context>

<tasks>

<task type="auto">
  <name>Task 1: Secure incident sub-routes and client detail route</name>
  <files>apps/web/src/app/api/incidents/[id]/route.js, apps/web/src/app/api/incidents/[id]/dossier/route.js, apps/web/src/app/api/clients/[id]/route.js</files>
  <action>
For each file:
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. For each handler (GET, PUT, DELETE):
   - Add at start: `const { authorized, response, user } = await requireRole(request, []);`
   - Add: `if (!authorized) return response;`
3. Keep params destructuring AFTER auth check

**incidents/[id]/route.js** - GET, PUT (incident details)
**incidents/[id]/dossier/route.js** - GET (full incident dossier)
**clients/[id]/route.js** - GET, PUT, DELETE (client details)

Do NOT modify SQL queries or response logic.
  </action>
  <verify>
Grep for requireRole in each file. Confirm all handlers are protected.
  </verify>
  <done>
Incident detail, dossier, and client detail routes require authentication.
  </done>
</task>

<task type="auto">
  <name>Task 2: Secure interview routes</name>
  <files>apps/web/src/app/api/interviews/route.js, apps/web/src/app/api/interviews/[id]/route.js, apps/web/src/app/api/interviews/[id]/analyze/route.js, apps/web/src/app/api/interview-witnesses/route.js</files>
  <action>
For each file:
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. Wrap all handlers (GET, POST, PUT, DELETE) with auth check
3. Use `requireRole(request, [])` for any authenticated user

**interviews/route.js** - GET, POST
**interviews/[id]/route.js** - GET, PUT, DELETE
**interviews/[id]/analyze/route.js** - POST (AI analysis)
**interview-witnesses/route.js** - GET, POST

Preserve existing params handling and SQL queries.
  </action>
  <verify>
Grep for requireRole in each file. Confirm all handlers are protected.
  </verify>
  <done>
All interview-related routes require authentication.
  </done>
</task>

<task type="auto">
  <name>Task 3: Secure evidence and corrective actions routes</name>
  <files>apps/web/src/app/api/evidence/route.js, apps/web/src/app/api/corrective-actions/route.js, apps/web/src/app/api/corrective-actions/[id]/route.js</files>
  <action>
For each file:
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. Wrap all handlers with auth check using `requireRole(request, [])`

**evidence/route.js** - GET, POST (evidence files)
**corrective-actions/route.js** - GET, POST
**corrective-actions/[id]/route.js** - GET, PUT, DELETE

Preserve existing logic.
  </action>
  <verify>
Grep for requireRole in each file. Confirm all handlers are protected.
  </verify>
  <done>
Evidence and corrective action routes require authentication.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 10 files have requireRole import
- [ ] All handlers check authorization
- [ ] No syntax errors
- [ ] Params handling preserved for [id] routes
</verification>

<success_criteria>

- All 10 incident/investigation routes require authentication
- Original business logic unchanged
- Consistent auth pattern across all routes
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-03-SUMMARY.md`
</output>
