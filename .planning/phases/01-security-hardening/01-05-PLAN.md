---
phase: 01-security-hardening
plan: 05
type: execute
depends_on: ["01-03", "01-04"]
files_modified: [
  apps/web/src/app/api/panel-physicians/route.js,
  apps/web/src/app/api/panel-physicians/[id]/route.js,
  apps/web/src/app/api/root-cause/route.js,
  apps/web/src/app/api/root-cause/[id]/route.js,
  apps/web/src/app/api/status-logs/route.js,
  apps/web/src/app/api/status-logs/[id]/route.js,
  apps/web/src/app/api/status-log-entries/route.js,
  apps/web/src/app/api/status-log-entries/[id]/route.js,
  apps/web/src/app/api/trip-entries/route.js,
  apps/web/src/app/api/trip-entries/[id]/route.js,
  apps/web/src/app/api/dashboard/stats/route.js,
  apps/web/src/app/api/push-tokens/route.js,
  apps/web/src/app/api/push-subscriptions/route.js,
  apps/web/src/app/api/secure-form-links/route.js,
  apps/web/src/app/api/secure-form-links/verify/route.js,
  apps/web/src/app/api/secure-form-links/resolve/route.js
]
---

<objective>
Add authentication to remaining API routes and verify complete security coverage.

Purpose: Complete the security hardening by securing all remaining routes.
Output: All API routes (except auth endpoints) require valid JWT. Phase 1 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-hardening/01-03-SUMMARY.md
@.planning/phases/01-security-hardening/01-04-SUMMARY.md

**Auth pattern:**
```javascript
import { requireRole } from "@/app/api/utils/auth";

export async function GET(request) {
  const { authorized, response, user } = await requireRole(request, []);
  if (!authorized) return response;
  // ... rest
}
```

**Special cases:**
- secure-form-links/verify and /resolve may need to allow unauthenticated access (for external form submission) - verify business logic first
- push-tokens/route.js - authenticated users registering their push tokens
- dashboard/stats - authenticated users viewing stats
</context>

<tasks>

<task type="auto">
  <name>Task 1: Secure physician, root-cause, and status routes</name>
  <files>apps/web/src/app/api/panel-physicians/route.js, apps/web/src/app/api/panel-physicians/[id]/route.js, apps/web/src/app/api/root-cause/route.js, apps/web/src/app/api/root-cause/[id]/route.js, apps/web/src/app/api/status-logs/route.js, apps/web/src/app/api/status-logs/[id]/route.js, apps/web/src/app/api/status-log-entries/route.js, apps/web/src/app/api/status-log-entries/[id]/route.js</files>
  <action>
For each file:
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. Wrap all handlers with auth check using `requireRole(request, [])`

**panel-physicians/** - GET, POST, PUT, DELETE (managing physician panel)
**root-cause/** - GET, POST, PUT, DELETE (root cause analysis)
**status-logs/** - GET, POST, PUT, DELETE (status tracking)
**status-log-entries/** - GET, POST, PUT, DELETE (log entries)
  </action>
  <verify>
Grep for requireRole in each file.
  </verify>
  <done>
Physician, root-cause, and status routes secured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Secure trip, dashboard, and push notification routes</name>
  <files>apps/web/src/app/api/trip-entries/route.js, apps/web/src/app/api/trip-entries/[id]/route.js, apps/web/src/app/api/dashboard/stats/route.js, apps/web/src/app/api/push-tokens/route.js, apps/web/src/app/api/push-subscriptions/route.js</files>
  <action>
For each file:
1. Add import: `import { requireRole } from "@/app/api/utils/auth";`
2. Wrap all handlers with auth check using `requireRole(request, [])`

**trip-entries/** - GET, POST, PUT, DELETE (mileage trip tracking)
**dashboard/stats** - GET (dashboard statistics)
**push-tokens** - POST (register push token)
**push-subscriptions** - GET, POST, DELETE (manage subscriptions)
  </action>
  <verify>
Grep for requireRole in each file.
  </verify>
  <done>
Trip, dashboard, and push notification routes secured.
  </done>
</task>

<task type="auto">
  <name>Task 3: Secure form links and verify complete coverage</name>
  <files>apps/web/src/app/api/secure-form-links/route.js, apps/web/src/app/api/secure-form-links/verify/route.js, apps/web/src/app/api/secure-form-links/resolve/route.js</files>
  <action>
**secure-form-links/route.js:**
- Add auth check (creating secure links requires auth)

**secure-form-links/verify/route.js and resolve/route.js:**
- Read the files first to understand their purpose
- If they are meant for external (unauthenticated) form submission via secure token, leave them without requireRole but add a comment explaining why
- If they are internal operations, add auth check

After securing these routes, run verification:
```bash
grep -rL "requireRole" apps/web/src/app/api --include="route.js" | grep -v "auth/"
```

The only routes without requireRole should be:
- auth/login - login endpoint
- auth/logout - logout endpoint
- auth/me - get current user
- secure-form-links/verify - if token-based auth
- secure-form-links/resolve - if token-based auth
- test-simple - if it exists for testing only
  </action>
  <verify>
Run the grep command. List any routes still missing auth and justify why they don't need it.
  </verify>
  <done>
All API routes secured. Phase 1: Security Hardening complete.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 16 files processed
- [ ] Run full audit: `grep -rL "requireRole" apps/web/src/app/api --include="route.js" | grep -v "auth/"`
- [ ] Only auth/* and justified special routes remain unauthenticated
- [ ] No syntax errors
</verification>

<success_criteria>

- All remaining routes secured
- Full codebase audit shows complete coverage
- Backdoor removed (Plan 01)
- All 43+ routes secured (Plans 02-05)
- Phase 1: Security Hardening COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-05-SUMMARY.md` with:
- Complete list of all routes secured
- Any routes left unauthenticated with justification
- Confirmation that backdoor is removed
- Phase completion status
</output>
