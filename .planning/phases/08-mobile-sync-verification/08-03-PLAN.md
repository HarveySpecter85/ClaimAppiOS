# Plan 08-03: Audit Relationship Integrity During Sync

## Objective
Verify data relationships are maintained during offline sync

## Scope
Audit only - document findings for Phase 10 fixes

---

## Tasks

### Task 1: Audit Employee Creation During Sync
**Files**: `apps/mobile/src/context/SyncContext.jsx`, `apps/web/src/app/api/employees/route.js`

- [ ] Check employee creation before incident
- [ ] Document orphan employee risk
- [ ] Verify employeeId assignment flow
- [ ] Check what happens if employee POST fails

### Task 2: Audit client_id Handling
**Files**: `apps/mobile/src/context/SyncContext.jsx`, `apps/mobile/src/hooks/useIncidentForm.jsx`

- [ ] Check client_id fallback to 1
- [ ] Verify where client_id comes from
- [ ] Document data corruption risk
- [ ] Check if client_id is validated

### Task 3: Audit Incident Creation During Sync
**Files**: `apps/mobile/src/context/SyncContext.jsx`, `apps/web/src/app/api/incidents/route.js`

- [ ] Check required fields validation (API side)
- [ ] Verify FK relationships enforced
- [ ] Document NULL employee_id scenario
- [ ] Check what happens if incident POST fails

### Task 4: Document Atomicity Gaps
**Output**: Gap analysis for Phase 10

- [ ] What operations can partially fail
- [ ] Map failure scenarios and their impact
- [ ] Document what rollback is needed
- [ ] Create recommendations for Phase 10

---

## Files to Read

```
apps/mobile/src/context/SyncContext.jsx
apps/mobile/src/hooks/useIncidentForm.jsx
apps/web/src/app/api/incidents/route.js
apps/web/src/app/api/employees/route.js
```

## Files to Modify
None (audit only - creates SUMMARY.md)

---

## Verification
- [ ] Employee creation flow documented
- [ ] client_id handling documented
- [ ] Incident creation flow documented
- [ ] Atomicity gaps documented
- [ ] SUMMARY.md created with findings
