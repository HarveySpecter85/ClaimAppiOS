# Summary 06-03: Audit Status Tracking and Audit Trail

## Audit Date
2026-01-17

## Objective
Verify status transitions and audit logging mechanisms in the claims processing workflow.

---

## Task 1: Audit Status Transition Logging

### File Reviewed
`apps/web/src/app/api/utils/audit.js`

### Findings

**STATUS_CHANGE Events ARE Logged:**
- The `logAudit()` function supports `STATUS_CHANGE` as a valid `actionType`
- Status changes are differentiated from regular `UPDATE` events in `apps/web/src/app/api/incidents/[id]/route.js` (lines 112-115):
  ```javascript
  actionType:
    body.status && body.status !== oldData.status
      ? "STATUS_CHANGE"
      : "UPDATE",
  ```

**Data Captured:**
| Field | Description | Status |
|-------|-------------|--------|
| `entity_type` | Type of entity (e.g., 'incident', 'client', 'employee') | Captured |
| `entity_id` | ID of the entity being modified | Captured |
| `action_type` | Type of action (CREATE, UPDATE, DELETE, STATUS_CHANGE) | Captured |
| `performed_by_id` | User ID who performed the action | Captured (nullable) |
| `performed_by_name` | User name who performed the action | Captured (defaults to "System/Unknown") |
| `changes` | JSON object with old/new values | Captured |
| `created_at` | Timestamp of the audit log entry | Auto-generated by DB |

**Changes Object Structure:**
- For UPDATE/STATUS_CHANGE: `{ field_name: { old: value, new: value } }`
- For CREATE: `{ initial_state: { ...newData } }`
- Differences are calculated via `calculateDifferences()` function
- Ignored fields: `updated_at`, `created_at`, `analysis_data`

**Performer Tracking:**
- Both `performed_by_id` and `performed_by_name` are captured
- Falls back to `{ id: null, name: "System/Unknown" }` if not provided
- Relies on frontend passing `performed_by_user` in request body (NOT extracted from JWT token)

### Gap Identified
**CRITICAL:** Performer tracking relies on the frontend sending `body.performed_by_user`. This is easily spoofed and not validated against the authenticated user from the JWT token. The `user` object is available from `requireRole()` but is not used for audit logging.

---

## Task 2: Audit Notification System

### File Reviewed
`apps/web/src/app/api/utils/notifications.js`

### Findings

**Functions Available:**

1. **`sendPushNotifications(tokens, title, body, data)`**
   - Low-level function to send to specific Expo Push Tokens
   - Uses Expo Push API (`https://exp.host/--/api/v2/push/send`)
   - Limited to <100 tokens (no chunking implemented)

2. **`notifyIncidentSubscribers(incidentId, title, body, extraData)`**
   - Notifies all devices subscribed to a specific incident
   - Queries `push_subscriptions` table by `incident_id`
   - De-duplicates tokens before sending
   - Used for status change notifications

3. **`notifyAllDevices(title, body, data)`**
   - Broadcasts to ALL registered devices
   - Queries `push_tokens` table
   - Comment indicates this should filter by admin role (NOT implemented)

**Notification Triggers Documented:**

| Trigger | Function Used | File |
|---------|---------------|------|
| Incident status change | `notifyIncidentSubscribers()` | `incidents/[id]/route.js` |
| New corrective action | `notifyIncidentSubscribers()` | `corrective-actions/route.js` |
| New incident created | `notifyAllDevices()` | `incidents/route.js` |
| New message on incident | Direct Expo API call | `messages/route.js` |

**Push Integration Status:**
- Expo Push Notifications fully integrated
- Two subscription models:
  - `push_subscriptions`: Per-incident subscriptions
  - `push_tokens`: Global device tokens
- No web push (Expo only - mobile-focused)

### Gaps Identified

1. **No notification logging**: Notifications sent are not logged to audit trail
2. **No delivery confirmation**: No tracking of notification delivery success/failure
3. **No user preference management**: No opt-out mechanism
4. **notifyAllDevices() has no role filtering**: Despite comment suggesting admin-only broadcasts

---

## Task 3: Document Audit Trail Gaps

### Missing Timestamps

| Issue | Location | Severity |
|-------|----------|----------|
| None | Timestamps are auto-generated via DB | N/A |

**Note:** The `created_at` timestamp is properly handled at the database level. No missing timestamp issues found.

### Missing User Attribution

| Issue | Severity | Details |
|-------|----------|---------|
| Performer from frontend, not JWT | HIGH | `performed_by_user` is sent from frontend rather than extracted from authenticated JWT. Easily spoofed. |
| DELETE operations not logged for clients | HIGH | `clients/[id]/route.js` DELETE does not call `logAudit()` |
| Corrective action updates not logged | MEDIUM | `corrective-actions/[id]/route.js` PATCH does not call `logAudit()` |
| No user context for incident creation | MEDIUM | `incidents/route.js` POST does not call `logAudit()` for CREATE |

### Actions NOT Logged

| Entity | CREATE | UPDATE | DELETE | STATUS_CHANGE |
|--------|--------|--------|--------|---------------|
| incidents | NO | YES | N/A | YES |
| clients | NO | YES | NO | N/A |
| employees | YES | NO | N/A | N/A |
| corrective_actions | NO | NO | N/A | NO |
| evidence | NO | NO | N/A | N/A |
| root_cause_analysis | NO | NO | N/A | N/A |
| messages | NO | N/A | N/A | N/A |
| interviews | NO | NO | N/A | N/A |

### Additional Gaps

1. **Silent failure on audit errors**: Audit logging failures only log to console, no alerting
2. **No audit log retention policy**: Logs accumulate indefinitely
3. **No audit log immutability**: No mechanism to prevent audit log modification
4. **IMPORT action type**: Custom action type used for employee import (not documented in schema)
5. **Entity ID 0 used for imports**: Employee import uses `entityId: 0` which is non-standard

---

## Phase 10 Recommendations

### Critical (Must Fix)

1. **Extract performer from JWT token, not request body**
   - Modify all API routes to use `user` from `requireRole()` for audit logging
   - Do NOT trust `body.performed_by_user`
   - Example fix in `incidents/[id]/route.js`:
     ```javascript
     const performedBy = { id: user.id, name: user.name };
     ```

2. **Add audit logging to all CRUD operations**
   - Incident CREATE
   - Client DELETE
   - Corrective action CREATE/UPDATE
   - Evidence CREATE
   - Root cause analysis CREATE/UPDATE
   - Messages CREATE

### High Priority

3. **Log notification events**
   - Track when notifications are sent
   - Record delivery status (success/failure)
   - Include in audit trail for compliance

4. **Add role filtering to `notifyAllDevices()`**
   - Implement the admin-only filtering mentioned in the code comment

5. **Standardize audit action types**
   - Document all valid action types
   - Add IMPORT to official schema documentation

### Medium Priority

6. **Implement audit log protection**
   - Make audit_logs table append-only (no UPDATE/DELETE permissions)
   - Add integrity checksums

7. **Add alerting for audit failures**
   - Send to error tracking service (Sentry, etc.)
   - Don't just console.error

8. **Implement audit log retention policy**
   - Archive logs older than X years
   - Maintain compliance requirements

---

## Files Audited

| File | Purpose |
|------|---------|
| `apps/web/src/app/api/utils/audit.js` | Core audit logging utility |
| `apps/web/src/app/api/utils/notifications.js` | Push notification utilities |
| `apps/web/src/app/api/audit-logs/route.js` | Audit logs API endpoint |
| `apps/web/src/app/api/incidents/[id]/route.js` | Incident PATCH with audit |
| `apps/web/src/app/api/incidents/route.js` | Incident GET/POST (no audit on POST) |
| `apps/web/src/app/api/clients/[id]/route.js` | Client CRUD (DELETE not logged) |
| `apps/web/src/app/api/employees/route.js` | Employee GET/POST with audit |
| `apps/web/src/app/api/employees/import/route.js` | Bulk import with audit |
| `apps/web/src/app/api/corrective-actions/route.js` | CREATE (no audit) |
| `apps/web/src/app/api/corrective-actions/[id]/route.js` | UPDATE (no audit) |
| `apps/web/src/app/api/evidence/route.js` | Evidence CREATE (no audit) |
| `apps/web/src/app/api/root-cause/route.js` | Root cause CREATE (no audit) |
| `apps/web/src/app/api/messages/route.js` | Messages CREATE (no audit) |
| `apps/web/src/app/api/push-subscriptions/route.js` | Subscription management |
| `apps/web/src/app/api/push-tokens/route.js` | Device token management |
| `apps/mobile/src/components/AuditLogTimeline.jsx` | Mobile audit log display |

---

## Summary

The audit logging infrastructure is well-designed but inconsistently applied:

**Strengths:**
- Solid `logAudit()` utility with difference calculation
- STATUS_CHANGE properly differentiated from UPDATE
- Changes captured with old/new values
- Timestamps automatically managed

**Critical Weaknesses:**
- Performer identity trusted from frontend (security vulnerability)
- Many CRUD operations not logged at all
- No notification event logging
- No audit log protection/immutability

**Coverage Estimate:** ~30% of data-modifying operations are properly audited
