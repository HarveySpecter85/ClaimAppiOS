---
phase: 02-authentication-audit
plan: 03
type: execute
depends_on: []
files_modified: []
---

<objective>
Verify role assignment and role checking work correctly throughout the system.

Purpose: Ensure RBAC (Role-Based Access Control) properly restricts access based on user roles.
Output: Documented verification that role system is working correctly.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files to audit:**
@apps/web/src/app/api/admin-users/route.js (user creation with role)
@apps/web/src/app/api/admin-users/[id]/route.js (user update)
@apps/web/src/app/api/admin-users/[id]/client-roles/route.js (role assignment)
@apps/web/src/app/api/utils/auth.js (role checking in requireRole)

**Role architecture:**
- System roles: global_admin, standard (stored in admin_users.system_role)
- Legacy role field: admin_users.role (backward compatibility)
- Client roles: user_client_roles table (per-client permissions)
- Role checking: requireRole(request, ["global_admin"]) pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit role assignment in admin-users endpoints</name>
  <files>apps/web/src/app/api/admin-users/route.js, apps/web/src/app/api/admin-users/[id]/route.js</files>
  <action>
Read and verify role assignment:

**User creation (POST /admin-users):**
1. Verify system_role is validated (only valid values accepted)
2. Verify only global_admin can create users
3. Check if default role is set appropriately

**User update (PUT /admin-users/[id]):**
1. Verify role updates are restricted to global_admin
2. Verify users cannot elevate their own role
3. Check for privilege escalation vulnerabilities

Document findings. Fix any issues.
  </action>
  <verify>
Read admin-users routes. Confirm:
- Uses requireRole with global_admin restriction
- Role field is validated
  </verify>
  <done>
Role assignment in admin-users verified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit client-specific role assignment</name>
  <files>apps/web/src/app/api/admin-users/[id]/client-roles/route.js</files>
  <action>
Read and verify client role assignment:

1. Verify only global_admin can assign client roles
2. Verify client_id is validated (exists in database)
3. Verify company_role is validated
4. Check x-user-id header usage - CRITICAL: should use JWT user, not header
5. Verify delete properly removes role

**Known issue to fix:** x-user-id header is client-supplied and should be replaced with user from JWT.

If x-user-id issue found, fix it by using the authenticated user from JWT instead.
  </action>
  <verify>
Read client-roles route. Confirm:
- Uses requireRole with global_admin
- Audit logging uses JWT user (not x-user-id header)
  </verify>
  <done>
Client role assignment audited. x-user-id issue fixed if present.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify role checking logic in requireRole</name>
  <files>apps/web/src/app/api/utils/auth.js</files>
  <action>
Read and verify role checking:

1. Verify allowedRoles array is checked correctly
2. Verify empty allowedRoles (any authenticated) works
3. Verify backward compatibility with legacy role field
4. Check that client_roles are fetched and available to handlers
5. Verify no role bypass through case sensitivity or type coercion

Document findings. Fix any issues.
  </action>
  <verify>
Read auth.js role checking section. Confirm:
- Checks both system_role and legacy role
- Returns client_roles for handlers to use
  </verify>
  <done>
Role checking logic verified correct.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] User creation role validation verified
- [ ] User update role protection verified
- [ ] Client role assignment secured
- [ ] x-user-id header issue addressed
- [ ] requireRole logic correct
</verification>

<success_criteria>

- Only global_admin can create/modify users
- Role assignment properly restricted
- No privilege escalation possible
- x-user-id header replaced with JWT user where applicable
- Role checking handles all edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-audit/02-03-SUMMARY.md` with:
- Role assignment audit findings
- Client role assignment findings
- requireRole logic verification
- Fixes applied (especially x-user-id)
</output>
