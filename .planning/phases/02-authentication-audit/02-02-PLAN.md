---
phase: 02-authentication-audit
plan: 02
type: execute
depends_on: []
files_modified: []
---

<objective>
Verify session management works correctly for web (cookies) and mobile (SecureStore).

Purpose: Ensure sessions are properly created, maintained, and destroyed across platforms.
Output: Documented verification that session management is working correctly.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files to audit:**
@apps/web/src/app/api/auth/login/route.js (cookie setting)
@apps/web/src/app/api/auth/logout/route.js (cookie clearing)
@apps/web/src/app/api/auth/token/route.js (token retrieval)
@apps/mobile/src/utils/auth/store.js (mobile session storage)
@apps/mobile/src/utils/auth/useAuth.js (mobile auth hook)

**Session architecture:**
- Web: JWT cookies (next-auth.session-token, __Secure-next-auth.session-token)
- Mobile: Expo SecureStore with Zustand state
- Cookie attributes: HttpOnly, SameSite=Lax, Max-Age=30 days
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit web cookie session management</name>
  <files>apps/web/src/app/api/auth/login/route.js, apps/web/src/app/api/auth/logout/route.js</files>
  <action>
Read and verify cookie session handling:

**Login (cookie setting):**
1. Verify HttpOnly flag is set (prevents XSS access)
2. Verify SameSite attribute is set (prevents CSRF)
3. Verify Secure flag logic (should be set for HTTPS)
4. Check cookie Max-Age is reasonable (30 days current)
5. Verify dual cookie strategy works for proxy environments

**Logout (cookie clearing):**
1. Verify both cookie variants are cleared
2. Verify Max-Age is set to 0 or expires is in past
3. Verify no other cleanup is needed

Document findings. Fix any issues.
  </action>
  <verify>
Read login and logout routes. Confirm:
- Cookies have HttpOnly and SameSite flags
- Logout clears both cookie variants
  </verify>
  <done>
Web cookie session management verified secure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit mobile SecureStore session management</name>
  <files>apps/mobile/src/utils/auth/store.js, apps/mobile/src/utils/auth/useAuth.js</files>
  <action>
Read and verify mobile session handling:

1. Verify SecureStore is used (not AsyncStorage) for JWT
2. Verify session object structure is consistent
3. Verify logout clears SecureStore properly
4. Check for race conditions in auth state updates
5. Verify useAuth hook correctly initializes from stored session

Document findings. Fix any issues.
  </action>
  <verify>
Read store.js and useAuth.js. Confirm:
- Uses SecureStore for JWT storage
- Logout function clears stored session
  </verify>
  <done>
Mobile SecureStore session management verified.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify /api/auth/token endpoint for mobile token retrieval</name>
  <files>apps/web/src/app/api/auth/token/route.js</files>
  <action>
Read and verify the token endpoint:

1. Check how mobile apps retrieve JWT after web-based login
2. Verify token is only returned to authenticated requests
3. Check for any token leakage risks
4. Verify the expo-web-success callback flow

Document findings. Fix any issues.
  </action>
  <verify>
Read token route. Confirm:
- Returns JWT only when valid session exists
- Does not expose token to unauthenticated requests
  </verify>
  <done>
Token retrieval endpoint verified secure.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Web cookie security attributes verified
- [ ] Logout properly clears sessions
- [ ] Mobile SecureStore usage verified
- [ ] Token retrieval endpoint secure
</verification>

<success_criteria>

- Web sessions use secure cookie attributes
- Mobile sessions use SecureStore (not AsyncStorage)
- Logout properly clears sessions on both platforms
- No session fixation or hijacking risks identified
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-audit/02-02-SUMMARY.md` with:
- Web cookie session audit findings
- Mobile SecureStore audit findings
- Token retrieval endpoint findings
- Any issues found and fixed
</output>
