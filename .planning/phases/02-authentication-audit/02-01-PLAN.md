---
phase: 02-authentication-audit
plan: 01
type: execute
depends_on: []
files_modified: []
---

<objective>
Verify JWT token generation, encoding, and validation work correctly end-to-end.

Purpose: Ensure authentication tokens are cryptographically secure and properly validated.
Output: Documented verification that JWT flow is working correctly, any issues identified and fixed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-hardening/01-05-SUMMARY.md

**Key files to audit:**
@apps/web/src/app/api/auth/login/route.js
@apps/web/src/app/api/utils/auth.js

**Auth architecture:**
- JWT encoding: @auth/core/jwt with AUTH_SECRET
- JWT validation: getToken() from @auth/core/jwt
- Password hashing: Argon2
- Token payload: { name, email, sub (user.id), picture, role, system_role }

**Phase 1 established:**
- 50/56 routes secured with requireRole()
- 6 auth endpoints intentionally unauthenticated
- Backdoor removed from login
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit JWT token generation in login endpoint</name>
  <files>apps/web/src/app/api/auth/login/route.js</files>
  <action>
Read and verify the login endpoint:

1. Verify password comparison uses Argon2 correctly (argon2.verify)
2. Verify JWT payload includes all required fields (name, email, sub, system_role)
3. Verify AUTH_SECRET is used from environment (not hardcoded)
4. Check token expiration is set appropriately
5. Verify no sensitive data leaks in JWT payload (no password hash)

Document findings. If issues found, fix them.
  </action>
  <verify>
Read the login route and confirm:
- Argon2 used for password verification
- JWT payload does not contain password_hash
- AUTH_SECRET from process.env
  </verify>
  <done>
Login JWT generation verified secure. Documented findings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit JWT validation in requireRole middleware</name>
  <files>apps/web/src/app/api/utils/auth.js</files>
  <action>
Read and verify the requireRole middleware:

1. Verify getToken() is called with correct secret from environment
2. Verify token validation fails properly when:
   - No token present (returns 401)
   - Invalid token (returns 401)
   - User not found in database (returns 401)
3. Verify role checking logic handles both system_role and legacy role fields
4. Check if any authorization bypass is possible
5. Verify the dual cookie strategy (HTTP and HTTPS variants)

Document findings. If issues found, fix them.
  </action>
  <verify>
Read auth.js and confirm:
- getToken uses AUTH_SECRET from process.env
- Returns 401 for missing/invalid tokens
- User lookup happens after token validation
  </verify>
  <done>
JWT validation verified secure. Documented findings.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify /api/auth/me endpoint returns correct user data</name>
  <files>apps/web/src/app/api/auth/me/route.js</files>
  <action>
Read and verify the /api/auth/me endpoint:

1. Verify it uses requireRole or equivalent auth check
2. Verify it returns user data from database (not just JWT payload)
3. Verify no sensitive fields are returned (password_hash should be excluded)
4. Check that client_roles are properly fetched and returned

Document findings. If issues found, fix them.
  </action>
  <verify>
Read me route and confirm:
- Uses authentication (JWT or cookie validation)
- Does not return password_hash
- Returns user profile with roles
  </verify>
  <done>
/api/auth/me endpoint verified. Returns appropriate user data without sensitive fields.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Login JWT generation audited and verified secure
- [ ] requireRole middleware audited and verified secure
- [ ] /api/auth/me endpoint verified
- [ ] No hardcoded secrets found
- [ ] No sensitive data in JWT payloads
</verification>

<success_criteria>

- JWT token generation follows security best practices
- JWT validation properly rejects invalid tokens
- No authorization bypass vulnerabilities found
- All findings documented
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-audit/02-01-SUMMARY.md` with:
- JWT generation audit findings
- JWT validation audit findings
- /api/auth/me audit findings
- Any issues found and fixed
- Recommendations for improvement (if any)
</output>
